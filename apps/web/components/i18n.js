"use client";
import { createContext, useContext, useEffect, useState } from 'react';

export const dict = {
  en: {
    // Nav
    Analysis: 'Analysis',
    Community: 'Community',
    Login: 'Login',
    MyAnalysis: 'My Analysis',
    CreatePost: 'Create Post',
    Profile: 'Profile',
    Logout: 'Logout',
    // Home
    HomeHeroTitle: 'Hear your heart. Understand your health.',
    HomeHeroDesc: 'Upload heart sound recordings to visualize waveforms and spectrograms, using algorithms to extract insights, and communicate with a global community.',
    GetStarted: 'Get Started',
    ExploreCommunity: 'Explore Community',
    GuideTitle: 'Start Analysis',
    GuideDesc: 'You can upload up to 10 recordings now. We will create analysis records and take you to your history.',
    GuideUpload: 'Upload recordings',
    GuideCancel: 'Cancel',
    HeartSound101: 'Heart Sound 101',
    HeartSound101Desc: 'Heart sounds (S1, S2) arise from valve closures; murmurs may indicate turbulent flow. Visualizing waveforms and spectrograms helps contextualize intensity, timing, and frequency bands.',
    AboutVH: 'About VisualHealth',
    AboutVHDesc: 'An open, modular platform for heart sound analysis. Privacy-first storage, per-service data isolation, and a growing library of analysis modules.',
    HomeFeaturesTitle: 'Why VisualHealth',
    Feat1Title: 'Clinical-grade PCG pipeline',
    Feat1Desc: 'S1/S2 segmentation, timing metrics, murmur energy and QC baselines.',
    Feat2Title: 'Privacy-first storage',
    Feat2Desc: 'Encrypted per-user media isolation with service-level separation.',
    Feat3Title: 'Interactive tools',
    Feat3Desc: 'Zoomable waveform, spectrogram, and instant playback for detail review.',
    Feat4Title: 'Community & sharing',
    Feat4Desc: 'Share anonymized insights and learn from global cases.',
    DemoTitle: 'Interactive Demo',
    DemoDesc: 'A synthetic heart sound to try zoom, pan, and spectrogram in your browser.',
    HomeAITitle: 'AI Health Guardian',
    HomeAIDesc: 'Clinically inspired AI delivers precise, reliable insights in seconds — always on, always by your side.',
    HomeAIPillar1Title: 'Precision & Trust',
    HomeAIPillar1Desc: 'Built on latest PCG analytics + AI reasoning; aligned with cardiology practice and stable across recordings.',
    HomeAIPillar2Title: 'Instant & Accessible',
    HomeAIPillar2Desc: 'Screening-grade results in seconds, anytime, anywhere — no appointments.',
    HomeAIPillar3Title: 'Early Warning & Peace of Mind',
    HomeAIPillar3Desc: 'Spot subtle abnormalities early at low cost; act before symptoms escalate.',
    HomeAIStat1: '≈30s result',
    HomeAIStat2: '24/7 self-check',
    HomeAIStat3: 'Screening-grade',
    HomeAISampleTitle: 'Sample AI Insight',
    HomeAISampleSummary: 'Regular rhythm (HR ~72 bpm). S1/S2 amplitudes within expected range. No clear murmur pattern detected.',
    HomeAISampleRisks: 'No obvious abnormality.',
    HomeAISampleAdvice: 'Stay active and hydrated. Retest in 1–2 weeks or earlier if symptoms. Seek care promptly for persistent chest pain, shortness of breath, or palpitations.',
    HomeAIFineprint: 'Screening-grade insight, not a medical diagnosis.',
    MedicalTitle: 'Medical Endorsement',
    MedicalDesc: 'Pre-screening methods inspired by PhysioNet community and peer-reviewed baselines. Collaborations to be announced.',
    CommunityHomeTitle: 'Community Stories',
    Story1: '“Thanks to VisualHealth, I could visualize changes during rehab.”',
    Story2: '“The spectrogram helped me understand my murmur pattern.”',
    Story3: '“Sharing anonymized recordings made discussions much clearer.”',
    FooterPrivacy: 'Privacy',
    FooterTeam: 'Team',
    FooterFAQ: 'FAQ',
    PrivacyText: 'We value privacy. Your recordings are stored with per-user isolation and can be deleted anytime.',
    TeamText: 'We are an interdisciplinary team spanning signal processing and clinical workflows.',
    FAQText: 'Questions? Reach out and we will add answers here.',
    // Auth
    LoginTitle: 'Login',
    SignupTitle: 'Sign up',
    Email: 'Email',
    Password: 'Password',
    DisplayName: 'Display name',
    CreateAccount: 'Create account',
    ForgotPassword: 'Forgot password',
    SendResetEmail: 'Send reset email',
    ResetEmailSent: 'If the email exists, a reset link was sent.',
    OpenReset: 'Open reset',
    VerifyEmail: 'Verify email',
    ResendVerification: 'Resend verification',
    EnterCode: 'Enter code',
    Verify: 'Verify',
    ResendCode: 'Resend code',
    CodeSentHint: 'We have sent a 6-digit verification code to your email. Enter it to continue.',
    ResendIn: 'Resend in',
    InvalidEmail: 'Please enter a valid email',
    PasswordMin: 'Password must be at least 6 characters',
    SignupEmailHint: 'After sign-up, verify your email via the link sent to you (dev: token returned inline).',
    VerificationEmailSent: 'Verification email sent.',
    OpenVerify: 'Open verify',
    Onboarding: 'Complete Your Profile',
    Next: 'Next',
    Skip: 'Skip',
    Finish: 'Finish',
    PrivacyTitle: 'Privacy',
    VisibilityPreset: 'Visibility preset',
    Private: 'Private',
    DoctorOnly: 'Doctor only',
    Public: 'Public',
    ResetPassword: 'Reset password',
    NewPassword: 'New password',
    ConfirmPassword: 'Confirm password',
    PasswordsDontMatch: 'Passwords do not match',
    PasswordResetOk: 'Password reset. You can login now.',
    EmailVerifiedOk: 'Email verified!',
    PleaseVerifyEmailFirst: 'Please verify email first',
    NoAccount: 'No account? Sign up',
    HaveAccount: 'Have an account? Login',
    // Analysis list/detail
    AnalysisTitle: 'Analysis',
    LoginToView: 'Please login to view your analysis history.',
    NewAnalysis: 'New Analysis',
    NoRecords: 'No analysis records yet.',
    Back: '← Back',
    Features: 'Features',
    Waveform: 'Waveform',
    Spectrogram: 'Spectrogram',
    Title: 'Title',
    EditTitle: 'Edit title',
    Duration: 'Duration (s)',
    SampleRate: 'Sample Rate',
    RMS: 'RMS',
    ZCR: 'ZCR (/s)',
    PeakRate: 'Peak Rate (/s)',
    SpectralCentroid: 'Spectral Centroid',
    Bandwidth: 'Bandwidth',
    Rolloff95: 'Rolloff 95%',
    Flatness: 'Flatness',
    Flux: 'Flux',
    CrestFactor: 'Crest Factor',
    // AI analysis
    AIAnalysis: 'AI Analysis',
    RunAI: 'Run AI Analysis',
    Analyzing: 'Analyzing…',
    SubmittedBG: 'Submitted, processing in background…',
    AIGeneratedAt: 'AI generated at',
    StartConversation: 'Start Conversation',
    AIConversation: 'AI Conversation',
    Send: 'Send',
    TypeMessage: 'Type a message…',
    HRShort: 'HR',
    S1S2Amp: 'S1:S2 amplitude ratio',
    SystoleSec: 'Systole (s)',
    DiastoleSec: 'Diastole (s)',
    HFRatio: 'High freq energy ratio',
    AudioGain: 'Audio Gain',
    GainOn: 'On',
    GainOff: 'Off',
    GainLabel: 'Gain',
    ClinicalAnalysis: 'Clinical PCG Analysis',
    Segmentation: 'Segmentation',
    HeartRate: 'Heart Rate (bpm)',
    RRMean: 'RR mean (s)',
    RRStd: 'RR std (s)',
    Systole: 'Systole (ms)',
    Diastole: 'Diastole (ms)',
    DSRatio: 'D/S ratio',
    S2Split: 'S2 split (A2–P2, ms)',
    A2OS: 'A2–OS (ms)',
    S1Intensity: 'S1 intensity',
    S2Intensity: 'S2 intensity',
    Murmur: 'Murmur metrics',
    SysHF: 'Systolic HF energy',
    DiaHF: 'Diastolic HF energy',
    SysShape: 'Systolic shape',
    QC: 'Quality control',
    SNR: 'SNR (dB)',
    MotionPct: 'Motion/resp artifacts (%)',
    UsablePct: 'Usable time (%)',
    // Extras
    Extras: 'Extended Metrics',
    RespAndSplit: 'Respiration & S2 Split',
    RespRate: 'Respiratory rate',
    RespDominance: 'Respiration dominance',
    S2SplitType: 'S2 split type',
    S2SplitCorr: 'Split–respiration correlation',
    AdditionalSounds: 'Additional sounds',
    S3Prob: 'S3 probability',
    S4Prob: 'S4 probability',
    EjectionClickProb: 'Ejection click probability',
    OpeningSnapProb: 'Opening snap probability',
    MurmurScreening: 'Murmur (screening)',
    Present: 'Present',
    Phase: 'Phase',
    GradeProxy: 'Screening grade (0–3)',
    Confidence: 'Confidence',
    SysCoverage: 'Systolic coverage',
    SysPitch: 'Systolic pitch',
    DiaCoverage: 'Diastolic coverage',
    DiaPitch: 'Diastolic pitch',
    RhythmLabel: 'Rhythm',
    RRCV: 'RR coefficient of variation',
    PoincareSD12: 'Poincaré SD1/SD2',
    SampleEntropy: 'Sample entropy',
    ContactNoise: 'Contact noise suspected',
    S1Width: 'S1 width (ms)',
    S2Width: 'S2 width (ms)',
    Expand: 'Expand',
    Collapse: 'Collapse',
    Disclaimer: 'Disclaimer: This tool provides screening-grade PCG analysis based on established signal processing baselines (e.g., Springer segmentation). It is not a medical device and not a substitute for clinical diagnosis. Please consult echocardiography and clinical judgement for final decisions.',
    Cancel: 'Cancel',
    Loading: 'Loading...',
    // Community
    CommunityTitle: 'Community',
    LoginToPost: 'Login to Post',
    NewPost: 'New Post',
    CreatePostTitle: 'Create Post',
    ShareStory: 'Share your story...',
    AddImages: 'Add Images',
    Post: 'Post',
    // Settings
    ProfileTitle: 'Profile',
    PleaseLoginManage: 'Please login to manage profile.',
    Save: 'Save',
    // Profile fields
    UserId: 'User ID',
    Copy: 'Copy',
    Copied: 'Copied!',
    ChangeAvatar: 'Change Avatar',
    ViewAvatar: 'View Avatar',
    BirthDate: 'Birth date',
    Gender: 'Gender',
    Male: 'Male',
    Female: 'Female',
    Other: 'Other',
    PreferNotSay: 'Prefer not to say',
    HeightCm: 'Height (cm)',
    WeightKg: 'Weight (kg)',
    BMI: 'BMI',
    Phone: 'Phone',
    NextNameChangeAt: 'Next nickname change at',
    SaveChanges: 'Save Changes',
  },
  zh: {
    // Nav
    Analysis: '分析记录',
    Community: '社区',
    Login: '登录',
    MyAnalysis: '我的分析',
    CreatePost: '发帖',
    Profile: '个人资料',
    Logout: '退出',
    // Home
    HomeHeroTitle: '听见心声，洞察健康',
    HomeHeroDesc: '上传心音录音以可视化波形与频谱图，算法分析心音特征，在全球社区交流分享。',
    GetStarted: '开始使用',
    ExploreCommunity: '探索社区',
    GuideTitle: '开始分析',
    GuideDesc: '你可以一次上传最多 10 个录音，我们会创建分析记录并带你进入“分析记录”页面。',
    GuideUpload: '上传录音',
    GuideCancel: '取消',
    HeartSound101: '心音入门 101',
    HeartSound101Desc: '心音（S1、S2）源于瓣膜关闭；杂音提示湍流。可视化波形与评谱有助于理解强度、时序与频带。',
    AboutVH: '关于 VisualHealth',
    AboutVHDesc: '一个开放、模块化的心音分析平台。以隐私为先，服务级数据隔离，持续增长的分析模块库。',
    HomeFeaturesTitle: '为何选择 VisualHealth',
    Feat1Title: '临床级 PCG 流程',
    Feat1Desc: 'S1/S2 分割、时距学指标、杂音能量与质量控制基线。',
    Feat2Title: '隐私优先的存储',
    Feat2Desc: '加密的用户级媒体隔离，服务级数据分离。',
    Feat3Title: '交互式工具',
    Feat3Desc: '可缩放波形、频谱与即时播放，便于细节查看。',
    Feat4Title: '社区与分享',
    Feat4Desc: '匿名分享见解，与全球案例共同学习。',
    DemoTitle: '交互式演示',
    DemoDesc: '一段合成心音，直接在浏览器中体验缩放、平移与频谱。',
    HomeAITitle: 'AI 健康守护',
    HomeAIDesc: '以临床思维为准绳，兼顾精准与稳定，在数十秒内给出可靠结论——随时随地，守护在你身边。',
    HomeAIPillar1Title: '精准与权威',
    HomeAIPillar1Desc: '基于最新心音分析与大模型推理，结果与心内科实践一致，更稳定可复现。',
    HomeAIPillar2Title: '便捷与普及',
    HomeAIPillar2Desc: '数秒内获得筛查级结果，无需预约、无需等待，随时随地自测。',
    HomeAIPillar3Title: '早筛与安心',
    HomeAIPillar3Desc: '以极低成本早期识别异常，养成日常监测习惯，在症状明显前主动干预。',
    HomeAIStat1: '≈30秒出结论',
    HomeAIStat2: '24/7 自测',
    HomeAIStat3: '筛查级',
    HomeAISampleTitle: 'AI 示例结论',
    HomeAISampleSummary: '节律规则（心率约 72 次/分）。S1/S2 幅度在预期范围内。未见明显杂音形态。',
    HomeAISampleRisks: '未见明显异常。',
    HomeAISampleAdvice: '保持规律运动与充足饮水；若有不适建议 1–2 周内复测。如出现持续胸痛、呼吸困难或心悸，请及时就医。',
    HomeAIFineprint: '筛查级参考，非最终医学诊断。',
    MedicalTitle: '医学背书',
    MedicalDesc: '借鉴 PhysioNet 社区与同行评审基线的预筛查方法。合作机构敬请期待。',
    CommunityHomeTitle: '社区分享',
    Story1: '“多亏了 VisualHealth，我能直观对比康复过程变化。”',
    Story2: '“频谱图让我理解了我的杂音形态。”',
    Story3: '“匿名分享录音后，讨论清晰多了。”',
    FooterPrivacy: '隐私',
    FooterTeam: '团队',
    FooterFAQ: '常见问题',
    PrivacyText: '我们重视隐私。你的录音以用户级隔离存储，随时可删除。',
    TeamText: '团队来自信号处理与临床工作流程等跨学科背景。',
    FAQText: '有问题？欢迎联系我们，我们会补充常见问答。',
    // Auth
    LoginTitle: '登录',
    SignupTitle: '注册',
    Email: '邮箱',
    Password: '密码',
    DisplayName: '昵称',
    CreateAccount: '创建账号',
    ForgotPassword: '忘记密码',
    SendResetEmail: '发送重置邮件',
    ResetEmailSent: '如果该邮箱存在，我们已发送重置链接。',
    OpenReset: '打开重置页',
    VerifyEmail: '验证邮箱',
    ResendVerification: '重发验证邮件',
    EnterCode: '输入验证码',
    Verify: '验证',
    ResendCode: '重发验证码',
    CodeSentHint: '我们已向你的邮箱发送 6 位验证码，请输入以继续。',
    ResendIn: '可在以下时间后重发',
    InvalidEmail: '请输入有效邮箱地址',
    PasswordMin: '密码至少 6 位',
    SignupEmailHint: '注册后请通过邮件链接完成邮箱验证（开发模式下会直接返回 token）。',
    VerificationEmailSent: '验证邮件已发送。',
    OpenVerify: '打开验证页',
    Onboarding: '完善个人资料',
    Next: '下一步',
    Skip: '跳过',
    Finish: '完成',
    PrivacyTitle: '隐私',
    VisibilityPreset: '可见性预设',
    Private: '仅自己',
    DoctorOnly: '医生可见',
    Public: '公开',
    ResetPassword: '重置密码',
    NewPassword: '新密码',
    ConfirmPassword: '确认密码',
    PasswordsDontMatch: '两次输入的密码不一致',
    PasswordResetOk: '密码已重置，可以登录了。',
    EmailVerifiedOk: '邮箱已验证！',
    PleaseVerifyEmailFirst: '请先完成邮箱验证',
    NoAccount: '没有账号？去注册',
    HaveAccount: '已有账号？去登录',
    // Analysis list/detail
    AnalysisTitle: '分析记录',
    LoginToView: '请登录后查看历史分析记录。',
    NewAnalysis: '新建分析',
    NoRecords: '还没有分析记录。',
    Back: '← 返回',
    Features: '特征',
    Waveform: '波形图',
    Spectrogram: '频谱图',
    Title: '标题',
    EditTitle: '编辑标题',
    Duration: '时长（秒）',
    SampleRate: '采样率',
    RMS: '均方根（RMS）',
    ZCR: '过零率（次/秒）',
    PeakRate: '峰事件率（次/秒）',
    SpectralCentroid: '谱质心',
    Bandwidth: '带宽',
    Rolloff95: '95%谱衰减',
    Flatness: '谱平坦度',
    Flux: '谱流量',
    CrestFactor: '峰因子',
    // AI analysis
    AIAnalysis: 'AI 分析',
    RunAI: '运行AI分析',
    Analyzing: '分析中…',
    SubmittedBG: '已提交，后台生成中…',
    AIGeneratedAt: 'AI已生成于',
    StartConversation: '开启AI对话',
    AIConversation: 'AI 对话',
    Send: '发送',
    TypeMessage: '输入消息…',
    HRShort: '心率',
    S1S2Amp: 'S1:S2 幅度比',
    SystoleSec: '收缩期（秒）',
    DiastoleSec: '舒张期（秒）',
    HFRatio: '高频能量占比',
    AudioGain: '音频增益',
    GainOn: '已开启',
    GainOff: '未开启',
    GainLabel: '增益',
    ClinicalAnalysis: '临床 PCG 分析',
    Segmentation: '分割',
    HeartRate: '心率（次/分）',
    RRMean: 'RR均值（秒）',
    RRStd: 'RR标准差（秒）',
    Systole: '收缩期（毫秒）',
    Diastole: '舒张期（毫秒）',
    DSRatio: '舒/收比',
    S2Split: 'S2分裂（A2–P2，毫秒）',
    A2OS: 'A2–OS（毫秒）',
    S1Intensity: 'S1强度',
    S2Intensity: 'S2强度',
    Murmur: '杂音指标',
    SysHF: '收缩期高频能量',
    DiaHF: '舒张期高频能量',
    SysShape: '收缩期形态',
    QC: '质量控制',
    SNR: '信噪比（dB）',
    MotionPct: '体动/呼吸伪迹占比（%）',
    UsablePct: '可用时间占比（%）',
    // Extras
    Extras: '扩展指标',
    RespAndSplit: '呼吸与分裂',
    RespRate: '呼吸频率',
    RespDominance: '呼吸主导度',
    S2SplitType: '第二心音分裂类型',
    S2SplitCorr: '分裂-呼吸相关性',
    AdditionalSounds: '附加音',
    S3Prob: 'S3 概率',
    S4Prob: 'S4 概率',
    EjectionClickProb: '喷射音概率',
    OpeningSnapProb: '开放拍概率',
    MurmurScreening: '杂音（筛查）',
    Present: '存在',
    Phase: '相位',
    GradeProxy: '筛查等级（0–3）',
    Confidence: '置信度',
    SysCoverage: '收缩期覆盖',
    SysPitch: '收缩期主频',
    DiaCoverage: '舒张期覆盖',
    DiaPitch: '舒张期主频',
    RhythmLabel: '节律',
    RRCV: 'RR 变异系数',
    PoincareSD12: 'SD1/SD2',
    SampleEntropy: '样本熵',
    ContactNoise: '接触噪声',
    S1Width: 'S1宽度（毫秒）',
    S2Width: 'S2宽度（毫秒）',
    Expand: '展开',
    Collapse: '收起',
    Disclaimer: '免责声明：本工具基于经典的信号处理基线（如 Springer 分割）提供筛查级心音分析，非医疗器械，不能替代临床诊断。最终结论请以超声心动图与临床判断为准。',
    Cancel: '取消',
    Loading: '加载中…',
    // Community
    CommunityTitle: '社区',
    LoginToPost: '登录后发帖',
    NewPost: '发布新贴',
    CreatePostTitle: '创建帖子',
    ShareStory: '分享你的故事…',
    AddImages: '添加图片',
    Post: '发布',
    // Settings
    ProfileTitle: '个人资料',
    PleaseLoginManage: '请登录后管理资料。',
    Save: '保存',
    // Profile fields
    UserId: '账号ID',
    Copy: '复制',
    Copied: '已复制！',
    ChangeAvatar: '更换头像',
    ViewAvatar: '查看头像',
    BirthDate: '出生日期',
    Gender: '性别',
    Male: '男',
    Female: '女',
    Other: '其他',
    PreferNotSay: '不透露',
    HeightCm: '身高（cm）',
    WeightKg: '体重（kg）',
    BMI: 'BMI',
    Phone: '手机号',
    NextNameChangeAt: '下次可修改昵称时间',
    SaveChanges: '保存更改',
  }
};

export const I18nCtx = createContext({ initialLang: 'en' });

export function I18nProvider({ initialLang = 'en', children }) {
  return (<I18nCtx.Provider value={{ initialLang }}>{children}</I18nCtx.Provider>);
}

export function useI18n() {
  const ctx = useContext(I18nCtx);
  const initialFromCtx = ctx?.initialLang === 'zh' ? 'zh' : (ctx?.initialLang === 'en' ? 'en' : null);
  // For initial render, prefer server-provided context; fallback to document attribute; default to 'en'.
  const [lang, setLang] = useState(() => {
    if (initialFromCtx) return initialFromCtx;
    if (typeof document !== 'undefined') {
      const d = document.documentElement.getAttribute('data-lang');
      if (d === 'zh' || d === 'en') return d;
    }
    return 'en';
  });
  useEffect(() => {
    const detect = () => {
      try {
        const d = document.documentElement.getAttribute('data-lang');
        if (d === 'zh' || d === 'en') return d;
        const h = document.documentElement.getAttribute('lang');
        if (h === 'zh' || h === 'en') return h;
        const ls = localStorage.getItem('vh_lang');
        if (ls === 'zh' || ls === 'en') return ls;
      } catch {}
      return 'en';
    };
    setLang(detect());
    function onChange(ev){ const v = ev?.detail || detect(); setLang(v); }
    window.addEventListener('vh_lang_change', onChange);
    window.addEventListener('storage', onChange);
    return () => {
      window.removeEventListener('vh_lang_change', onChange);
      window.removeEventListener('storage', onChange);
    };
  }, []);
  const t = (k) => (dict[lang] && dict[lang][k]) || dict.en[k] || k;
  return { lang, t };
}

export function setGlobalLang(lang) {
  if (lang !== 'en' && lang !== 'zh') return;
  try { localStorage.setItem('vh_lang', lang); } catch {}
  if (typeof document !== 'undefined') document.documentElement.setAttribute('data-lang', lang);
  const ev = new CustomEvent('vh_lang_change', { detail: lang });
  window.dispatchEvent(ev);
}
